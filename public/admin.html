<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>Admin Dashboard ‚Äî Portfolio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    :root {
      --primary: #2563EB;
      --accent: #10B981;
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --text: #0F172A;
      --muted: #475569;
      --border: #E5E7EB;
      --error: #EF4444;
      --success: #10B981;
    }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    .login-container {
      display: none; min-height: 100vh; align-items: center; justify-content: center;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(16, 185, 129, 0.1));
    }
    .login-container.show { display: flex; }
    .login-box {
      background: var(--card); padding: 40px; border-radius: 14px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08); width: 100%; max-width: 400px;
    }
    .login-box h1 { margin: 0 0 24px; font-size: 1.8rem; text-align: center; }
    .form-group {
      margin-bottom: 16px;
    }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input[type="text"], input[type="password"], input[type="email"], textarea, select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 8px; font-family: inherit; font-size: 14px;
    }
    input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--primary); outline-offset: -1px;
    }
    textarea { resize: vertical; min-height: 80px; }
    .btn {
      padding: 12px 18px; border: none; border-radius: 8px; cursor: pointer;
      font-weight: 600; font-size: 14px; transition: all 160ms ease;
    }
    .btn-primary {
      background: var(--primary); color: white;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-secondary:hover { background: #dbe5f0; }
    .btn-danger { background: var(--error); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-success { background: var(--success); color: white; }
    .alert {
      padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px;
    }
    .alert-error { background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid var(--error); }
    .alert-success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
    .dashboard {
      display: none;
    }
    .dashboard.show { display: block; }
    .admin-header {
      background: var(--card); border-bottom: 1px solid var(--border);
      padding: 20px; display: flex; justify-content: space-between; align-items: center;
    }
    .admin-header h1 { margin: 0; font-size: 1.5rem; }
    .logout-btn {
      background: var(--error); color: white; border: none; padding: 8px 16px;
      border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .tabs {
      display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 12px 16px; background: none; border: none; color: var(--muted);
      cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;
      transition: all 160ms ease;
    }
    .tab.active {
      color: var(--primary); border-bottom-color: var(--primary);
    }
    .tab-content {
      display: none; background: var(--card); padding: 24px; border-radius: 12px;
      border: 1px solid var(--border);
    }
    .tab-content.active { display: block; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) {
      .two-col { grid-template-columns: 1fr; }
      .admin-header { flex-direction: column; gap: 12px; text-align: center; }
    }
    .list-item {
      background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .list-item button { padding: 6px 12px; font-size: 12px; }
    .file-input-wrapper {
      position: relative; overflow: hidden; display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute; left: -9999px;
    }
    .file-label {
      display: inline-block; padding: 10px 14px; background: var(--border);
      border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;
    }
    .file-label:hover { background: #d1d5db; }
    .preview-img {
      width: 200px; height: 200px; margin-top: 12px; border-radius: 12px;
      object-fit: cover; object-position: center; display: block;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    /* Upload UI Enhancements */
    .upload-section {
      background: var(--bg);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .upload-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .upload-progress {
      margin-top: 12px;
      display: none;
    }
    .upload-progress.show { display: block; }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 200ms ease;
    }
    .progress-text {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }
    .file-preview {
      background: var(--card);
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
      display: none;
      border: 1px solid var(--border);
    }
    .file-preview.show { display: block; }
    .file-preview-icon {
      font-size: 20px;
      margin-right: 8px;
      display: inline-block;
    }
    .file-preview-text {
      display: inline-block;
      word-break: break-all;
    }
    .status-message {
      font-size: 12px;
      margin-top: 8px;
      padding: 8px;
      border-radius: 6px;
      display: none;
    }
    .status-message.show { display: block; }
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }
  </style>
  
  <!-- Chart.js for Analytics Visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <!-- Socket.io for Real-Time Updates -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!-- Login -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <h1>üîê Admin Login</h1>
      <div id="loginAlert"></div>
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="username" placeholder="admin">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" id="loginBtn">Login</button>
      <p style="text-align: center; color: var(--muted); font-size: 12px; margin-top: 16px;">
        Default: admin / admin123
      </p>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="admin-header">
      <h1>üìä Admin Dashboard</h1>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <div class="container">
      <div id="dashboardAlert"></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="profile">Profile</button>
        <button class="tab" data-tab="skills">Skills</button>
        <button class="tab" data-tab="certificates">Certificates</button>
        <button class="tab" data-tab="projects">Projects</button>
        <button class="tab" data-tab="achievements">Achievements</button>
        <button class="tab" data-tab="analytics">üìä Analytics</button>
      </div>

      <!-- Profile Tab -->
      <div class="tab-content active" id="profileTab">
        <h2>Edit Profile</h2>
        <div class="two-col">
          <div>
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="name" placeholder="Your Name">
            </div>
            <div class="form-group">
              <label>Tagline</label>
              <input type="text" id="tagline" placeholder="Your Role">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="email" placeholder="your@email.com">
            </div>
            <div class="form-group">
              <label>Location</label>
              <input type="text" id="location" placeholder="City, Country">
            </div>
          </div>
          <div>
            <div class="form-group">
              <label>About</label>
              <textarea id="about" placeholder="Tell us about yourself..."></textarea>
            </div>
          </div>
        </div>

        <!-- Profile Image -->
        <div class="form-group">
          <label>Profile Image</label>
          <div class="upload-section">
            <div class="file-input-wrapper">
              <input type="file" id="profileImageInput" accept="image/jpeg,image/png,image/webp">
              <button type="button" class="btn btn-primary" onclick="document.getElementById('profileImageInput').click()">üìÅ Choose Image</button>
            </div>
            <div class="upload-progress" id="profileImageProgress">
              <div class="progress-bar">
                <div class="progress-fill" id="profileImageProgressFill"></div>
              </div>
              <div class="progress-text" id="profileImageProgressText">Uploading...</div>
            </div>
            <div class="file-preview" id="profileImagePreview">
              <img id="profilePreviewImg" class="preview-img" style="display: inline-block; margin: 0;">
            </div>
            <div class="status-message" id="profileImageStatus"></div>
            <div style="margin-top: 12px;">
              <img id="profilePreview" class="preview-img" style="display: none;">
            </div>
            <button type="button" class="btn btn-danger" id="deleteProfilePhotoBtn" style="margin-top: 8px; display: none;">üóëÔ∏è Delete Photo</button>
          </div>
        </div>

        <!-- Socials -->
        <div class="form-group">
          <label>Social Links</label>
          <div id="socialsList"></div>
          <button class="btn btn-secondary" id="addSocialBtn" style="margin-top: 8px;">+ Add Social</button>
        </div>

        <!-- Resume & CV -->
        <div class="two-col" style="margin-top: 20px;">
          <div>
            <label>Resume (PDF)</label>
            <div class="upload-section">
              <div class="file-input-wrapper">
                <input type="file" id="resumeInput" accept=".pdf,application/pdf">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('resumeInput').click()">üìÅ Choose File</button>
              </div>
              <div class="upload-progress" id="resumeProgress">
                <div class="progress-bar">
                  <div class="progress-fill" id="resumeProgressFill"></div>
                </div>
                <div class="progress-text" id="resumeProgressText">Uploading...</div>
              </div>
              <div class="file-preview" id="resumePreview">
                <div class="file-preview-icon">üìÑ</div>
                <div class="file-preview-text" id="resumeFileName"></div>
              </div>
              <div class="status-message" id="resumeStatus"></div>
              <button type="button" class="btn btn-danger" id="deleteResumeBtn" style="margin-top: 8px; display: none;">üóëÔ∏è Delete</button>
            </div>
          </div>
          <div>
            <label>CV (PDF)</label>
            <div class="upload-section">
              <div class="file-input-wrapper">
                <input type="file" id="cvInput" accept=".pdf,application/pdf">
                <button type="button" class="btn btn-primary" onclick="document.getElementById('cvInput').click()">üìÅ Choose File</button>
              </div>
              <div class="upload-progress" id="cvProgress">
                <div class="progress-bar">
                  <div class="progress-fill" id="cvProgressFill"></div>
                </div>
                <div class="progress-text" id="cvProgressText">Uploading...</div>
              </div>
              <div class="file-preview" id="cvPreview">
                <div class="file-preview-icon">üìã</div>
                <div class="file-preview-text" id="cvFileName"></div>
              </div>
              <div class="status-message" id="cvStatus"></div>
              <button type="button" class="btn btn-danger" id="deleteCvBtn" style="margin-top: 8px; display: none;">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>

        <button class="btn btn-primary" id="saveProfileBtn" style="margin-top: 20px;">üíæ Save Profile</button>
      </div>

      <!-- Skills Tab -->
      <div class="tab-content" id="skillsTab">
        <h2>Manage Skills</h2>
        <div id="skillsList"></div>
        <button class="btn btn-secondary" id="addSkillCatBtn" style="margin-top: 20px;">+ Add Skill Category</button>
        <button class="btn btn-primary" id="saveSkillsBtn" style="margin-top: 12px; margin-left: 8px;">üíæ Save Skills</button>
      </div>

      <!-- Certificates Tab -->
      <div class="tab-content" id="certificatesTab">
        <h2>Manage Certificates</h2>
        <div id="certificatesList"></div>
        <button class="btn btn-secondary" id="addCertBtn" style="margin-top: 20px;">+ Add Certificate</button>
        <button class="btn btn-primary" id="saveCertBtn" style="margin-top: 12px; margin-left: 8px;">üíæ Save Certificates</button>
      </div>

      <!-- Projects Tab -->
      <div class="tab-content" id="projectsTab">
        <h2>Manage Projects</h2>
        <div id="projectsList"></div>
        <button class="btn btn-secondary" id="addProjectBtn" style="margin-top: 20px;">+ Add Project</button>
        <button class="btn btn-primary" id="saveProjectsBtn" style="margin-top: 12px; margin-left: 8px;">üíæ Save Projects</button>
      </div>

      <!-- Achievements Tab -->
      <div class="tab-content" id="achievementsTab">
        <h2>Manage Achievements</h2>
        <div id="achievementsList"></div>
        <button class="btn btn-secondary" id="addAchievementBtn" style="margin-top: 20px;">+ Add Achievement</button>
        <button class="btn btn-primary" id="saveAchievementsBtn" style="margin-top: 12px; margin-left: 8px;">üíæ Save Achievements</button>
      </div>

      <!-- Analytics Tab -->
      <div class="tab-content" id="analyticsTab">
        <h2>üìä Visitor Analytics</h2>
        
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div style="background: #e0f2fe; padding: 20px; border-radius: 12px; border-left: 4px solid #2563EB;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">Unique Visitors</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="uniqueVisitors">--</div>
          </div>
          <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid #10B981;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">Page Views</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="pageViews">--</div>
          </div>
          <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">Resume Downloads</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="resumeDownloads">--</div>
          </div>
          <div style="background: #fce7f3; padding: 20px; border-radius: 12px; border-left: 4px solid #ec4899;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">CV Downloads</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="cvDownloads">--</div>
          </div>
          <div style="background: #f5e7ff; padding: 20px; border-radius: 12px; border-left: 4px solid #7C3AED;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">üî¥ Live Visitors</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="liveVisitorCount">0</div>
          </div>
          <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
            <div style="font-size: 12px; color: #475569; margin-bottom: 4px;">Total Tracked</div>
            <div style="font-size: 28px; font-weight: 700; color: #0F172A;" id="totalVisitors">--</div>
          </div>
        </div>

        <!-- Live Events Stream (Real-Time) -->
        <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 24px;">
          <h3 style="margin: 0 0 16px;">‚ö° Live Event Stream</h3>
          <div id="liveEventsList" style="min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc;">
            <div style="padding: 40px 20px; text-align: center; color: var(--muted);">
              Waiting for real-time events...
            </div>
          </div>
        </div>

        <!-- Top Pages & Clicks -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
          <!-- Top Pages Chart -->
          <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
            <h3 style="margin: 0 0 16px;">üîù Top Pages</h3>
            <canvas id="topPagesChart" height="200"></canvas>
            <div id="topPages" style="font-size: 13px; margin-top: 12px;"></div>
          </div>
          
          <!-- Top Clicks Chart -->
          <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
            <h3 style="margin: 0 0 16px;">üñ±Ô∏è Top Clicks</h3>
            <canvas id="topClicksChart" height="200"></canvas>
            <div id="topClicks" style="font-size: 13px; margin-top: 12px;"></div>
          </div>
        </div>

        <!-- Device Stats & Traffic Chart -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
          <!-- Device Chart -->
          <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
            <h3 style="margin: 0 0 16px;">üì± Device Breakdown</h3>
            <canvas id="deviceChart" height="200"></canvas>
            <div id="deviceStats" style="font-size: 13px; margin-top: 12px;"></div>
          </div>
          
          <!-- Traffic Over Time Chart -->
          <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
            <h3 style="margin: 0 0 16px;">üìà Traffic Overview</h3>
            <canvas id="trafficChart" height="200"></canvas>
          </div>
        </div>

        <!-- Event Filter & Table -->
        <div style="background: var(--card); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
          <h3 style="margin: 0 0 16px;">üìã Recent Events</h3>
          
          <div style="margin-bottom: 16px; display: flex; gap: 8px;">
            <select id="eventTypeFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
              <option value="">All Events</option>
              <option value="page_view">Page Views</option>
              <option value="click">Clicks</option>
              <option value="download">Downloads</option>
            </select>
            <button class="btn btn-primary" id="refreshEventsBtn" onclick="loadAnalyticsData()">üîÑ Refresh</button>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="padding: 12px; text-align: left;">Visitor</th>
                  <th style="padding: 12px; text-align: left;">Type</th>
                  <th style="padding: 12px; text-align: left;">Page</th>
                  <th style="padding: 12px; text-align: left;">Item</th>
                  <th style="padding: 12px; text-align: left;">Device</th>
                  <th style="padding: 12px; text-align: left;">Time</th>
                </tr>
              </thead>
              <tbody id="eventsTableBody">
                <tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--muted);">Loading events...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div id="analyticsPagination" style="margin-top: 16px; text-align: center; font-size: 13px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('token');
    let portfolioData = {};

    // Initialize
    if (token) {
      showDashboard();
    } else {
      showLogin();
    }

    // Login handler
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (data.success) {
          token = data.token;
          localStorage.setItem('token', token);
          showDashboard();
        } else {
          showAlert('loginAlert', data.error || 'Login failed', 'error');
        }
      } catch (error) {
        showAlert('loginAlert', 'Login error: ' + error.message, 'error');
      }
    });

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      token = null;
      localStorage.removeItem('token');
      // Clear any ongoing operations
      if (socket) {
        socket.disconnect();
        socket = null;
      }
      showLogin();
    });

    async function showDashboard() {
      document.getElementById('loginContainer').classList.remove('show');
      document.getElementById('dashboard').classList.add('show');
      await loadPortfolioData();
      setupTabs();
      setupEventListeners();
      loadAnalyticsData(); // Load analytics when dashboard shows
    }

    function showLogin() {
      document.getElementById('loginContainer').classList.add('show');
      document.getElementById('dashboard').classList.remove('show');
    }

    async function loadPortfolioData() {
      try {
        const response = await fetch(`${API_BASE}/portfolio/public/profile`);
        const data = await response.json();

        // API returns nested structure: { profile, skills, projects, ... }
        // Admin UI expects a flattened structure for backward-compatibility.
        portfolioData = {
          ...(data.profile || data),
          skills: data.skills || [],
          projects: data.projects || [],
          achievements: data.achievements || [],
          certificates: data.certificates || []
        };
        renderForms();
      } catch (error) {
        showAlert('dashboardAlert', 'Error loading data: ' + error.message, 'error');
      }
    }

    function renderForms() {
      // Profile form
      document.getElementById('name').value = portfolioData.name || '';
      document.getElementById('tagline').value = portfolioData.tagline || '';
      document.getElementById('email').value = portfolioData.email || '';
      document.getElementById('location').value = portfolioData.location || '';
      document.getElementById('about').value = portfolioData.about || '';

      if (portfolioData.profileImage) {
        const preview = document.getElementById('profilePreview');
        preview.src = portfolioData.profileImage;
        preview.style.display = 'block';
      }

      // Socials
      renderSocials();

      // Skills
      renderSkills();

      // Certificates
      renderCertificates();

      // Projects
      renderProjects();

      // Achievements
      renderAchievements();
    }

    function renderSocials() {
      const list = document.getElementById('socialsList');
      list.innerHTML = '';
      let socials = portfolioData.socials;
      // Defensive: ensure socials is always an object
      if (!socials || typeof socials !== 'object') {
        socials = {};
      } else if (Array.isArray(socials)) {
        // Convert array to object (migrate old data)
        const obj = {};
        socials.forEach((item, i) => {
          if (item && typeof item === 'object' && item.platform) {
            obj[item.platform] = item.url || '';
          } else if (typeof item === 'string') {
            obj['platform' + (i+1)] = item;
          }
        });
        socials = obj;
        portfolioData.socials = obj;
      }
      Object.entries(socials).forEach(([platform, url]) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div style="flex: 1; display: flex; gap: 8px; align-items: center;">
            <input type="text" placeholder="Platform (e.g., GitHub)" value="${platform}" 
              onchange="updateSocialPlatform('${platform}', this.value)">
            <input type="url" placeholder="URL" value="${url || ''}" style="margin-top: 8px;"
              onchange="updateSocialUrl('${platform}', this.value)">
          </div>
          <button class="btn btn-danger" onclick="removeSocial('${platform}')">‚úï</button>
        `;
        list.appendChild(div);
      });
    }

    function updateSocial(idx, field, value) {
      // Deprecated, replaced by updateSocialPlatform and updateSocialUrl
    }

    function updateSocialPlatform(oldPlatform, newPlatform) {
      if (!portfolioData.socials) portfolioData.socials = {};
      if (oldPlatform !== newPlatform && newPlatform) {
        portfolioData.socials[newPlatform] = portfolioData.socials[oldPlatform] || '';
        delete portfolioData.socials[oldPlatform];
        renderSocials();
      }
    }

    function updateSocialUrl(platform, url) {
      if (!portfolioData.socials) portfolioData.socials = {};
      portfolioData.socials[platform] = url;
    }

    function removeSocial(idx) {
      if (!portfolioData.socials) return;
      delete portfolioData.socials[idx];
      renderSocials();
    }

    document.getElementById('addSocialBtn').addEventListener('click', () => {
      if (!portfolioData.socials) portfolioData.socials = {};
      // Add a new empty social entry with a unique key
      let base = 'platform';
      let i = 1;
      while (portfolioData.socials[base + i]) i++;
      portfolioData.socials[base + i] = '';
      renderSocials();
    });

    // Skills
    function renderSkills() {
      const list = document.getElementById('skillsList');
      list.innerHTML = '';
      const skills = portfolioData.skills || [];

      skills.forEach((cat, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.style.display = 'block';
        const items = (cat.items || []).join(', ');
        div.innerHTML = `
          <label>Category</label>
          <input type="text" value="${cat.category || ''}" 
            onchange="updateSkillCat(${idx}, 'category', this.value)">
          <label style="margin-top: 8px;">Skills (comma-separated)</label>
          <input type="text" value="${items}" 
            onchange="updateSkillCat(${idx}, 'items', this.value.split(',').map(s => s.trim()))">
          <button class="btn btn-danger" onclick="removeSkillCat(${idx})" style="margin-top: 8px;">Remove</button>
        `;
        list.appendChild(div);
      });
    }

    function updateSkillCat(idx, field, value) {
      if (!portfolioData.skills) portfolioData.skills = [];
      if (!portfolioData.skills[idx]) portfolioData.skills[idx] = {};
      portfolioData.skills[idx][field] = value;
    }

    function removeSkillCat(idx) {
      portfolioData.skills.splice(idx, 1);
      renderSkills();
    }

    document.getElementById('addSkillCatBtn').addEventListener('click', () => {
      if (!portfolioData.skills) portfolioData.skills = [];
      portfolioData.skills.push({ category: '', items: [] });
      renderSkills();
    });

    // Certificates
    function renderCertificates() {
      const list = document.getElementById('certificatesList');
      list.innerHTML = '';
      const certs = portfolioData.certificates || [];

      certs.forEach((cert, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.style.display = 'block';
        div.innerHTML = `
          <input type="text" placeholder="Title" value="${cert.title || ''}" 
            onchange="updateCert(${idx}, 'title', this.value)">
          <input type="text" placeholder="Issuer" value="${cert.issuer || ''}" style="margin-top: 8px;"
            onchange="updateCert(${idx}, 'issuer', this.value)">
          <input type="text" placeholder="Date" value="${cert.date || ''}" style="margin-top: 8px;"
            onchange="updateCert(${idx}, 'date', this.value)">
          <input type="url" placeholder="Link" value="${cert.link || ''}" style="margin-top: 8px;"
            onchange="updateCert(${idx}, 'link', this.value)">
          <button class="btn btn-danger" onclick="removeCert(${idx})" style="margin-top: 8px;">Remove</button>
        `;
        list.appendChild(div);
      });
    }

    function updateCert(idx, field, value) {
      if (!portfolioData.certificates) portfolioData.certificates = [];
      if (!portfolioData.certificates[idx]) portfolioData.certificates[idx] = {};
      portfolioData.certificates[idx][field] = value;
    }

    function removeCert(idx) {
      portfolioData.certificates.splice(idx, 1);
      renderCertificates();
    }

    document.getElementById('addCertBtn').addEventListener('click', () => {
      if (!portfolioData.certificates) portfolioData.certificates = [];
      portfolioData.certificates.push({ title: '', issuer: '', date: '', link: '' });
      renderCertificates();
    });

    // Projects
    function renderProjects() {
      const list = document.getElementById('projectsList');
      list.innerHTML = '';
      const projects = portfolioData.projects || [];

      projects.forEach((project, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.style.display = 'block';
        const tags = (project.tags || []).join(', ');
        div.innerHTML = `
          <input type="text" placeholder="Title" value="${project.title || ''}" 
            onchange="updateProject(${idx}, 'title', this.value)">
          <input type="text" placeholder="Description" value="${project.description || ''}" style="margin-top: 8px;"
            onchange="updateProject(${idx}, 'description', this.value)">
          <input type="text" placeholder="Tags (comma-separated)" value="${tags}" style="margin-top: 8px;"
            onchange="updateProject(${idx}, 'tags', this.value.split(',').map(s => s.trim()))">
          <input type="url" placeholder="GitHub Link" value="${project.githubLink || ''}" style="margin-top: 8px;"
            onchange="updateProject(${idx}, 'githubLink', this.value)">
          <input type="url" placeholder="Live Demo Link" value="${project.liveLink || ''}" style="margin-top: 8px;"
            onchange="updateProject(${idx}, 'liveLink', this.value)">
          <button class="btn btn-danger" onclick="removeProject(${idx})" style="margin-top: 8px;">Remove</button>
        `;
        list.appendChild(div);
      });
    }

    function updateProject(idx, field, value) {
      if (!portfolioData.projects) portfolioData.projects = [];
      if (!portfolioData.projects[idx]) portfolioData.projects[idx] = {};
      portfolioData.projects[idx][field] = value;
    }

    function removeProject(idx) {
      portfolioData.projects.splice(idx, 1);
      renderProjects();
    }

    document.getElementById('addProjectBtn').addEventListener('click', () => {
      if (!portfolioData.projects) portfolioData.projects = [];
      portfolioData.projects.push({ title: '', description: '', tags: [], githubLink: '', liveLink: '' });
      renderProjects();
    });

    // Achievements
    function renderAchievements() {
      const list = document.getElementById('achievementsList');
      list.innerHTML = '';
      const achievements = portfolioData.achievements || [];

      achievements.forEach((achievement, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.style.display = 'block';
        div.innerHTML = `
          <input type="text" placeholder="Date" value="${achievement.date || ''}" 
            onchange="updateAchievement(${idx}, 'date', this.value)">
          <input type="text" placeholder="Title" value="${achievement.title || ''}" style="margin-top: 8px;"
            onchange="updateAchievement(${idx}, 'title', this.value)">
          <textarea placeholder="Detail" style="margin-top: 8px;"
            onchange="updateAchievement(${idx}, 'detail', this.value)">${achievement.detail || ''}</textarea>
          <button class="btn btn-danger" onclick="removeAchievement(${idx})" style="margin-top: 8px;">Remove</button>
        `;
        list.appendChild(div);
      });
    }

    function updateAchievement(idx, field, value) {
      if (!portfolioData.achievements) portfolioData.achievements = [];
      if (!portfolioData.achievements[idx]) portfolioData.achievements[idx] = {};
      portfolioData.achievements[idx][field] = value;
    }

    function removeAchievement(idx) {
      portfolioData.achievements.splice(idx, 1);
      renderAchievements();
    }

    document.getElementById('addAchievementBtn').addEventListener('click', () => {
      if (!portfolioData.achievements) portfolioData.achievements = [];
      portfolioData.achievements.push({ date: '', title: '', detail: '' });
      renderAchievements();
    });

    // Save handlers
    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/portfolio/admin/portfolio`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            profile: {
              name: document.getElementById('name').value,
              tagline: document.getElementById('tagline').value,
              email: document.getElementById('email').value,
              location: document.getElementById('location').value,
              about: document.getElementById('about').value
            }
          })
        });

        if (response.ok) {
          showAlert('dashboardAlert', 'Profile saved successfully!', 'success');
          await loadPortfolioData();
        } else {
          showAlert('dashboardAlert', 'Error saving profile', 'error');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Error: ' + error.message, 'error');
      }
    });

    document.getElementById('saveSkillsBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/portfolio/admin/skills`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ skills: portfolioData.skills })
        });

        if (response.ok) {
          showAlert('dashboardAlert', 'Skills saved!', 'success');
        } else {
          showAlert('dashboardAlert', 'Error saving skills', 'error');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Error: ' + error.message, 'error');
      }
    });

    document.getElementById('saveCertBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/portfolio/admin/certificates`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ certificates: portfolioData.certificates })
        });

        if (response.ok) {
          showAlert('dashboardAlert', 'Certificates saved!', 'success');
        } else {
          showAlert('dashboardAlert', 'Error saving certificates', 'error');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Error: ' + error.message, 'error');
      }
    });

    document.getElementById('saveProjectsBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/portfolio/admin/projects`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ projects: portfolioData.projects })
        });

        if (response.ok) {
          showAlert('dashboardAlert', 'Projects saved!', 'success');
        } else {
          showAlert('dashboardAlert', 'Error saving projects', 'error');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Error: ' + error.message, 'error');
      }
    });

    document.getElementById('saveAchievementsBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_BASE}/portfolio/admin/achievements`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ achievements: portfolioData.achievements })
        });

        if (response.ok) {
          showAlert('dashboardAlert', 'Achievements saved!', 'success');
        } else {
          showAlert('dashboardAlert', 'Error saving achievements', 'error');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Error: ' + error.message, 'error');
      }
    });

    // File uploads
    document.getElementById('profileImageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        showStatus('profileImageStatus', '‚ùå Only JPG, PNG, WEBP allowed', 'error');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showStatus('profileImageStatus', '‚ùå File too large (max 5MB)', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('profilePhoto', file);

      showProgress('profileImageProgress');
      hideStatus('profileImageStatus');

      try {
        const response = await fetch(`/api/uploads/profile-photo`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        updateProgress('profileImageProgressFill', 'profileImageProgressText', 100, 'Upload complete!');

        if (response.status === 403) {
          showStatus('profileImageStatus', '‚ùå IP not authorized', 'error');
          hideProgress('profileImageProgress');
          return;
        }

        if (response.status === 401) {
          showStatus('profileImageStatus', '‚ùå Session expired', 'error');
          hideProgress('profileImageProgress');
          return;
        }

        if (!response.ok) {
          const error = await response.json();
          showStatus('profileImageStatus', '‚ùå ' + (error.message || 'Upload failed'), 'error');
          hideProgress('profileImageProgress');
          return;
        }

        const data = await response.json();
        portfolioData.profileImage = data.url;
        
        // Show preview in admin dashboard
        document.getElementById('profilePreviewImg').src = data.url;
        document.getElementById('profileImagePreview').classList.add('show');
        document.getElementById('profilePreview').src = data.url;
        document.getElementById('profilePreview').style.display = 'none'; // Hide duplicate
        document.getElementById('deleteProfilePhotoBtn').style.display = 'inline-block';
        
        // Update hero section on public portfolio (SYNC)
        const profileImageContainer = document.getElementById('profileImageContainer');
        if (profileImageContainer) {
          profileImageContainer.innerHTML = '';
          const img = document.createElement('img');
          img.src = data.url;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.objectPosition = 'center';
          img.style.borderRadius = '12px';
          profileImageContainer.appendChild(img);
        }
        
        // Update header logo (SYNC)
        const logo = document.querySelector('.logo');
        if (logo) {
          logo.innerHTML = '';
          const logoImg = document.createElement('img');
          logoImg.src = data.url;
          logoImg.style.width = '100%';
          logoImg.style.height = '100%';
          logoImg.style.objectFit = 'cover';
          logoImg.style.borderRadius = '50%';
          logo.appendChild(logoImg);
          logo.style.background = 'none';
        }
        
        showStatus('profileImageStatus', '‚úì ' + (data.message || 'Uploaded successfully!'), 'success');
        showAlert('dashboardAlert', 'Profile image uploaded!', 'success');

        setTimeout(() => {
          hideProgress('profileImageProgress');
        }, 1500);

      } catch (error) {
        showStatus('profileImageStatus', '‚ùå ' + error.message, 'error');
        hideProgress('profileImageProgress');
      }

      e.target.value = '';
    });

    document.getElementById('resumeInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (file.type !== 'application/pdf') {
        showStatus('resumeStatus', '‚ùå Only PDF files allowed', 'error');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showStatus('resumeStatus', '‚ùå File too large (max 5MB)', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('resume', file);

      showProgress('resumeProgress');
      hideStatus('resumeStatus');

      try {
        const response = await fetch(`/api/uploads/resume`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        updateProgress('resumeProgressFill', 'resumeProgressText', 100, 'Upload complete!');

        if (response.status === 403) {
          showStatus('resumeStatus', '‚ùå IP not authorized', 'error');
          hideProgress('resumeProgress');
          return;
        }

        if (response.status === 401) {
          showStatus('resumeStatus', '‚ùå Session expired', 'error');
          hideProgress('resumeProgress');
          return;
        }

        if (!response.ok) {
          const error = await response.json();
          showStatus('resumeStatus', '‚ùå ' + (error.message || 'Upload failed'), 'error');
          hideProgress('resumeProgress');
          return;
        }

        const data = await response.json();
        portfolioData.resumeUrl = data.url;
        
        document.getElementById('resumeFileName').textContent = file.name + ' ‚úì';
        document.getElementById('resumePreview').classList.add('show');
        document.getElementById('deleteResumeBtn').style.display = 'inline-block';
        
        showStatus('resumeStatus', '‚úì ' + (data.message || 'Uploaded successfully!'), 'success');
        showAlert('dashboardAlert', 'Resume uploaded!', 'success');

        setTimeout(() => {
          hideProgress('resumeProgress');
        }, 1500);

      } catch (error) {
        showStatus('resumeStatus', '‚ùå ' + error.message, 'error');
        hideProgress('resumeProgress');
      }

      e.target.value = '';
    });

    document.getElementById('cvInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (file.type !== 'application/pdf') {
        showStatus('cvStatus', '‚ùå Only PDF files allowed', 'error');
        return;
      }

      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        showStatus('cvStatus', '‚ùå File too large (max 5MB)', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('cv', file);

      showProgress('cvProgress');
      hideStatus('cvStatus');

      try {
        const response = await fetch(`/api/uploads/cv`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        updateProgress('cvProgressFill', 'cvProgressText', 100, 'Upload complete!');

        if (response.status === 403) {
          showStatus('cvStatus', '‚ùå IP not authorized', 'error');
          hideProgress('cvProgress');
          return;
        }

        if (response.status === 401) {
          showStatus('cvStatus', '‚ùå Session expired', 'error');
          hideProgress('cvProgress');
          return;
        }

        if (!response.ok) {
          const error = await response.json();
          showStatus('cvStatus', '‚ùå ' + (error.message || 'Upload failed'), 'error');
          hideProgress('cvProgress');
          return;
        }

        const data = await response.json();
        portfolioData.cvUrl = data.url;
        
        document.getElementById('cvFileName').textContent = file.name + ' ‚úì';
        document.getElementById('cvPreview').classList.add('show');
        document.getElementById('deleteCvBtn').style.display = 'inline-block';
        
        showStatus('cvStatus', '‚úì ' + (data.message || 'Uploaded successfully!'), 'success');
        showAlert('dashboardAlert', 'CV uploaded!', 'success');

        setTimeout(() => {
          hideProgress('cvProgress');
        }, 1500);

      } catch (error) {
        showStatus('cvStatus', '‚ùå ' + error.message, 'error');
        hideProgress('cvProgress');
      }

      e.target.value = '';
    });

    // Delete buttons
    document.getElementById('deleteProfilePhotoBtn').addEventListener('click', async () => {
      if (!confirm('Delete profile photo?')) return;
      
      try {
        const response = await fetch(`/api/uploads/profile/profilePhoto`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          document.getElementById('profileImagePreview').classList.remove('show');
          document.getElementById('profilePreview').style.display = 'none';
          document.getElementById('deleteProfilePhotoBtn').style.display = 'none';
          portfolioData.profileImage = '';
          showAlert('dashboardAlert', 'Profile photo deleted', 'success');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Delete failed: ' + error.message, 'error');
      }
    });

    document.getElementById('deleteResumeBtn').addEventListener('click', async () => {
      if (!confirm('Delete resume?')) return;
      
      try {
        const response = await fetch(`/api/uploads/docs/resume`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          document.getElementById('resumePreview').classList.remove('show');
          document.getElementById('deleteResumeBtn').style.display = 'none';
          document.getElementById('resumeFileName').textContent = '';
          portfolioData.resumeUrl = '';
          showAlert('dashboardAlert', 'Resume deleted', 'success');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Delete failed: ' + error.message, 'error');
      }
    });

    document.getElementById('deleteCvBtn').addEventListener('click', async () => {
      if (!confirm('Delete CV?')) return;
      
      try {
        const response = await fetch(`/api/uploads/docs/cv`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          document.getElementById('cvPreview').classList.remove('show');
          document.getElementById('deleteCvBtn').style.display = 'none';
          document.getElementById('cvFileName').textContent = '';
          portfolioData.cvUrl = '';
          showAlert('dashboardAlert', 'CV deleted', 'success');
        }
      } catch (error) {
        showAlert('dashboardAlert', 'Delete failed: ' + error.message, 'error');
      }
    });

    // Helper functions
    function showProgress(progressId) {
      const el = document.getElementById(progressId);
      el.classList.add('show');
      document.getElementById(progressId + 'Fill').style.width = '0%';
    }

    function hideProgress(progressId) {
      document.getElementById(progressId).classList.remove('show');
    }

    function updateProgress(fillId, textId, percent, text) {
      document.getElementById(fillId).style.width = percent + '%';
      document.getElementById(textId).textContent = text;
    }

    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `status-message show status-${type}`;
    }

    function hideStatus(elementId) {
      const el = document.getElementById(elementId);
      el.classList.remove('show');
    }

    function renderForms() {
      // Profile form
      document.getElementById('name').value = portfolioData.name || '';
      document.getElementById('tagline').value = portfolioData.tagline || '';
      document.getElementById('email').value = portfolioData.email || '';
      document.getElementById('location').value = portfolioData.location || '';
      document.getElementById('about').value = portfolioData.about || '';

      if (portfolioData.profileImage) {
        const preview = document.getElementById('profilePreview');
        preview.src = portfolioData.profileImage;
        preview.style.display = 'none'; // Hide duplicate
        document.getElementById('profileImagePreview').classList.add('show');
        document.getElementById('profilePreviewImg').src = portfolioData.profileImage;
        document.getElementById('deleteProfilePhotoBtn').style.display = 'inline-block';
        
        // Update hero section on public portfolio (SYNC on load)
        const profileImageContainer = document.getElementById('profileImageContainer');
        if (profileImageContainer) {
          profileImageContainer.innerHTML = '';
          const img = document.createElement('img');
          img.src = portfolioData.profileImage;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.objectPosition = 'center';
          img.style.borderRadius = '12px';
          profileImageContainer.appendChild(img);
        }
        
        // Update header logo (SYNC on load)
        const logo = document.querySelector('.logo');
        if (logo) {
          logo.innerHTML = '';
          const logoImg = document.createElement('img');
          logoImg.src = portfolioData.profileImage;
          logoImg.style.width = '100%';
          logoImg.style.height = '100%';
          logoImg.style.objectFit = 'cover';
          logoImg.style.borderRadius = '50%';
          logo.appendChild(logoImg);
          logo.style.background = 'none';
        }
      }

      if (portfolioData.resumeUrl) {
        const fileName = portfolioData.resumeUrl.split('/').pop();
        document.getElementById('resumeFileName').textContent = fileName + ' ‚úì';
        document.getElementById('resumePreview').classList.add('show');
        document.getElementById('deleteResumeBtn').style.display = 'inline-block';
      }

      if (portfolioData.cvUrl) {
        const fileName = portfolioData.cvUrl.split('/').pop();
        document.getElementById('cvFileName').textContent = fileName + ' ‚úì';
        document.getElementById('cvPreview').classList.add('show');
        document.getElementById('deleteCvBtn').style.display = 'inline-block';
      }

      // Socials
      renderSocials();

      // Skills
      renderSkills();

      // Certificates
      renderCertificates();

      // Projects
      renderProjects();

      // Achievements
      renderAchievements();
    }

    // ============================================
    // ANALYTICS FUNCTIONS
    // ============================================

    let currentAnalyticsPage = 1;
    let analyticsPageSize = 50;
    let charts = {}; // Store chart instances
    
    // Chart.js Color Palette
    const chartColors = {
      primary: '#2563EB',
      secondary: '#7C3AED',
      accent: '#10B981',
      warning: '#F59E0B',
      error: '#EF4444',
      muted: '#94A3B8'
    };
    
    function createTopPagesChart(data) {
      const ctx = document.getElementById('topPagesChart');
      if (!ctx) return;
      
      // Destroy existing chart if it exists
      if (charts.topPages) charts.topPages.destroy();
      
      const labels = data.map(p => p._id?.substring(0, 20) || 'Unknown').slice(0, 5);
      const values = data.map(p => p.count).slice(0, 5);
      
      charts.topPages = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Page Views',
            data: values,
            backgroundColor: chartColors.primary,
            borderRadius: 6,
            borderSkipped: false,
            hoverBackgroundColor: chartColors.secondary
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { color: '#475569' },
              grid: { color: '#E2E8F0' }
            },
            y: {
              ticks: { color: '#475569' }
            }
          }
        }
      });
    }
    
    function createTopClicksChart(data) {
      const ctx = document.getElementById('topClicksChart');
      if (!ctx) return;
      
      if (charts.topClicks) charts.topClicks.destroy();
      
      const labels = data.map(c => c._id || 'Unknown').slice(0, 5);
      const values = data.map(c => c.count).slice(0, 5);
      
      charts.topClicks = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: [
              chartColors.primary,
              chartColors.secondary,
              chartColors.accent,
              chartColors.warning,
              chartColors.error
            ],
            borderColor: '#FFFFFF',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#475569', font: { size: 12 } }
            }
          }
        }
      });
    }
    
    function createDeviceChart(data) {
      const ctx = document.getElementById('deviceChart');
      if (!ctx) return;
      
      if (charts.device) charts.device.destroy();
      
      const labels = data.map(d => d._id || 'Unknown');
      const values = data.map(d => d.count);
      
      charts.device = new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: [
              chartColors.primary,
              chartColors.secondary,
              chartColors.accent
            ],
            borderColor: '#FFFFFF',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#475569', font: { size: 12 } }
            }
          },
          scales: {
            r: {
              ticks: { color: '#475569' },
              grid: { color: '#E2E8F0' }
            }
          }
        }
      });
    }
    
    function createTrafficChart(summary) {
      const ctx = document.getElementById('trafficChart');
      if (!ctx) return;
      
      if (charts.traffic) charts.traffic.destroy();
      
      // Generate 7-day simulation data
      const days = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
      const total = summary.pageViews || 0;
      const avgDaily = Math.ceil(total / 7);
      const trafficData = days.map((_, i) => {
        const variance = Math.floor(Math.random() * (avgDaily * 0.5));
        return avgDaily + (i % 2 === 0 ? variance : -variance);
      });
      
      charts.traffic = new Chart(ctx, {
        type: 'line',
        data: {
          labels: days,
          datasets: [{
            label: 'Page Views',
            data: trafficData,
            borderColor: chartColors.primary,
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: chartColors.primary,
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            hoverBackgroundColor: chartColors.secondary
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              display: true,
              labels: { color: '#475569', font: { size: 12 } }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#475569' },
              grid: { color: '#E2E8F0' }
            },
            x: {
              ticks: { color: '#475569' }
            }
          }
        }
      });
    }

    async function loadAnalyticsData() {
      try {
        // Load summary
        const summaryRes = await fetch(`${API_BASE}/admin/analytics/summary`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const summary = await summaryRes.json();

        // Load events
        const eventType = document.getElementById('eventTypeFilter')?.value || '';
        const eventsRes = await fetch(
          `${API_BASE}/admin/analytics/events?page=${currentAnalyticsPage}&limit=${analyticsPageSize}${eventType ? '&type=' + eventType : ''}`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        const events = await eventsRes.json();

        // Display summary
        document.getElementById('uniqueVisitors').textContent = summary.uniqueVisitors || '0';
        document.getElementById('pageViews').textContent = summary.pageViews || '0';
        document.getElementById('resumeDownloads').textContent = summary.resumeDownloads || '0';
        document.getElementById('cvDownloads').textContent = summary.cvDownloads || '0';

        // Display top pages
        const topPagesHtml = (summary.topPages || []).map((p, i) => 
          `<div style="margin-bottom: 8px;"><strong>${i + 1}. ${p._id || 'Unknown'}</strong> ‚Ä¢ ${p.count} views</div>`
        ).join('') || '<div style="color: var(--muted);">No data yet</div>';
        document.getElementById('topPages').innerHTML = topPagesHtml;
        
        // Top Pages Chart
        createTopPagesChart(summary.topPages || []);

        // Display top clicks
        const topClicksHtml = (summary.topClicks || []).map((c, i) => 
          `<div style="margin-bottom: 8px;"><strong>${i + 1}. ${c._id || 'Unknown'}</strong> ‚Ä¢ ${c.count} clicks</div>`
        ).join('') || '<div style="color: var(--muted);">No data yet</div>';
        document.getElementById('topClicks').innerHTML = topClicksHtml;
        
        // Top Clicks Chart
        createTopClicksChart(summary.topClicks || []);

        // Display device stats
        const deviceStatsHtml = (summary.deviceStats || []).map(d => 
          `<div style="margin-bottom: 8px;"><strong>${d._id}</strong> ‚Ä¢ ${d.count} ${d.count === 1 ? 'visit' : 'visits'}</div>`
        ).join('') || '<div style="color: var(--muted);">No data yet</div>';
        document.getElementById('deviceStats').innerHTML = deviceStatsHtml;
        
        // Device Breakdown Chart
        createDeviceChart(summary.deviceStats || []);
        
        // Traffic Overview Chart
        createTrafficChart(summary);

        // Display events table
        if (events.data && events.data.length > 0) {
          const tableHtml = events.data.map(evt => {
            const time = new Date(evt.createdAt).toLocaleString();
            const typeEmoji = {
              'page_view': 'üìÑ',
              'click': 'üñ±Ô∏è',
              'download': 'üì•'
            }[evt.type] || '‚Ä¢';
            return `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px;">${evt.visitorId}</td>
                <td style="padding: 12px;">${typeEmoji} ${evt.type}</td>
                <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${evt.page}</td>
                <td style="padding: 12px;">${evt.item || '‚Äî'}</td>
                <td style="padding: 12px;">${evt.device}</td>
                <td style="padding: 12px; font-size: 12px; color: var(--muted);">${time}</td>
              </tr>
            `;
          }).join('');
          document.getElementById('eventsTableBody').innerHTML = tableHtml;
        } else {
          document.getElementById('eventsTableBody').innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--muted);">No events yet</td></tr>';
        }

        // Pagination
        if (events.pages && events.pages > 1) {
          let paginationHtml = '';
          if (currentAnalyticsPage > 1) {
            paginationHtml += `<button class="btn btn-secondary" onclick="currentAnalyticsPage = ${currentAnalyticsPage - 1}; loadAnalyticsData()">‚Üê Previous</button> `;
          }
          paginationHtml += `Page ${currentAnalyticsPage} of ${events.pages}`;
          if (currentAnalyticsPage < events.pages) {
            paginationHtml += ` <button class="btn btn-secondary" onclick="currentAnalyticsPage = ${currentAnalyticsPage + 1}; loadAnalyticsData()">Next ‚Üí</button>`;
          }
          document.getElementById('analyticsPagination').innerHTML = paginationHtml;
        } else {
          document.getElementById('analyticsPagination').innerHTML = '';
        }

      } catch (error) {
        console.error('Error loading analytics:', error);
        showAlert('dashboardAlert', 'Error loading analytics: ' + error.message, 'error');
      }
    }

    // Event filter listener
    document.addEventListener('DOMContentLoaded', () => {
      const filterSelect = document.getElementById('eventTypeFilter');
      if (filterSelect) {
        filterSelect.addEventListener('change', () => {
          currentAnalyticsPage = 1;
          loadAnalyticsData();
        });
      }
    });

    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tabName + 'Tab').classList.add('active');
          
          // Reload analytics when analytics tab is clicked
          if (tabName === 'analytics') {
            loadAnalyticsData();
          }
        });
      });
    }

    function setupEventListeners() {
      // Already set up above
    }

    function showAlert(elementId, message, type) {
      const alert = document.getElementById(elementId);
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      setTimeout(() => {
        alert.textContent = '';
        alert.className = '';
      }, 5000);
    }

    // ============================================
    // REAL-TIME SOCKET.IO INTEGRATION
    // ============================================
    let socket = null;
    let liveEventsList = [];

    function initializeWebSocket() {
      try {
        // Connect to WebSocket server with authentication token
        const token = localStorage.getItem('adminToken');
        socket = io({
          auth: {
            token: token
          }
        });

        socket.on('connect', () => {
          console.log('‚úÖ Connected to real-time analytics');
          // Request live analytics updates
          socket.emit('request-live-analytics');
        });

        socket.on('disconnect', () => {
          console.log('‚ùå Disconnected from real-time analytics');
        });

        // Listen for real-time visitor events
        socket.on('visitor-event', (event) => {
          console.log('üìä Real-time event:', event);
          
          // Add to live events list (limit to last 20)
          liveEventsList.unshift({
            type: event.type,
            page: event.page,
            item: event.item || '-',
            device: event.device,
            timestamp: event.timestamp,
            visitorId: event.visitorId
          });
          
          if (liveEventsList.length > 20) {
            liveEventsList.pop();
          }

          // Update live events display if on analytics tab
          const analyticsTab = document.getElementById('analyticsTab');
          if (analyticsTab && analyticsTab.classList.contains('active')) {
            updateLiveEventsDisplay();
          }
        });

        // Listen for live visitor count updates
        socket.on('visitor-count', (data) => {
          console.log('üë• Live visitor count:', data);
          
          const visitorCountEl = document.getElementById('liveVisitorCount');
          if (visitorCountEl) {
            visitorCountEl.textContent = data.activeVisitors || 0;
          }

          const totalVisitorsEl = document.getElementById('totalVisitors');
          if (totalVisitorsEl) {
            totalVisitorsEl.textContent = data.totalVisitors || 0;
          }
        });

        socket.on('request-acknowledged', (data) => {
          console.log('‚ú® Admin dashboard connected for live updates');
        });

      } catch (error) {
        console.error('WebSocket initialization error:', error);
      }
    }

    function updateLiveEventsDisplay() {
      const container = document.getElementById('liveEventsList');
      if (!container) return;

      container.innerHTML = liveEventsList.map(event => `
        <div style="padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <strong>${event.type === 'page_view' ? 'üìÑ' : event.type === 'click' ? 'üëÜ' : 'üì•'} ${event.type.replace('_', ' ')}</strong>
            <span style="color: var(--muted); font-size: 12px;">${new Date(event.timestamp).toLocaleTimeString()}</span>
          </div>
          <div style="color: var(--muted); font-size: 12px;">
            <div>üìç ${event.page}</div>
            ${event.item !== '-' ? `<div>üîó ${event.item}</div>` : ''}
            <div>üì± ${event.device}</div>
          </div>
        </div>
      `).join('');
    }

    // Initialize WebSocket when user logs in successfully
    const originalShowDashboard = window.showDashboard;
    window.showDashboard = function() {
      originalShowDashboard();
      
      // Initialize WebSocket after dashboard is shown
      setTimeout(() => {
        if (!socket) {
          initializeWebSocket();
        }
      }, 500);
    };

    // Initialize WebSocket on page load if already logged in
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        setTimeout(() => {
          if (!socket) {
            initializeWebSocket();
          }
        }, 500);
      }
    });
  </script>
</body>
</html>
